services:
  postgres:
    # Includes pgvector extension for hybrid vector+graph search (optional).
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: lam
      POSTGRES_PASSWORD: lam
      POSTGRES_DB: lam
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lam -d lam"]
      interval: 2s
      timeout: 5s
      retries: 30
    volumes:
      - lam_hello_pg:/var/lib/postgresql/data

  lam:
    # Set LAM_IMAGE to a published LAM image (recommended for public demo repos).
    # For local dev, `compose.local.yml` can build this image from a local `lam-v2` checkout.
    image: ${LAM_IMAGE:-ghcr.io/tuckerjensendev/lam-prove-it:latest}
    depends_on:
      postgres:
        condition: service_healthy
    command: ["sh", "-lc", "node scripts/db-migrate.js && node dist/index.js"]
    environment:
      HOST: 0.0.0.0
      PORT: 8080
      DATABASE_URL: postgresql://lam:lam@postgres:5432/lam
      # Dev-only defaults (override via env if you want).
      LAM_MASTER_KEY_B64: ${LAM_MASTER_KEY_B64:-"DkdDKK1Bl6hR2Zi8WiiwRywJHq7em0yK8NHbmFYhkAc="}
      LAM_ADMIN_TOKEN: ${LAM_ADMIN_TOKEN:-"demo-admin"}
      LAM_CELL_DIR: /data/cells
      LAM_REJECT_CLIENT_SCOPE: "1"
    ports:
      # Bind to localhost to avoid exposing dev-only admin defaults to your LAN.
      - "127.0.0.1:${LAM_DEMO_HTTP_PORT:-8080}:8080"
    volumes:
      - ./data/cells:/data/cells
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8080/health | grep -q '\"ok\":true'"]
      interval: 2s
      timeout: 5s
      retries: 30

  lam_worker:
    image: ${LAM_IMAGE:-ghcr.io/tuckerjensendev/lam-prove-it:latest}
    depends_on:
      postgres:
        condition: service_healthy
      lam:
        condition: service_healthy
    command: ["sh", "-lc", "node dist/scripts/enrichment-worker.js"]
    environment:
      DATABASE_URL: postgresql://lam:lam@postgres:5432/lam
      LAM_MASTER_KEY_B64: ${LAM_MASTER_KEY_B64:-"DkdDKK1Bl6hR2Zi8WiiwRywJHq7em0yK8NHbmFYhkAc="}
      # Match the API server's cell storage config.
      LAM_CELL_STORE: fs
      LAM_CELL_DIR: /data/cells
      LAM_REJECT_CLIENT_SCOPE: "1"
    volumes:
      - ./data/cells:/data/cells

  demo:
    image: node:22-bookworm-slim
    depends_on:
      lam:
        condition: service_healthy
      lam_worker:
        condition: service_started
    command: ["sh", "-lc", "sleep infinity"]
    working_dir: /demo
    volumes:
      - ./demo:/demo:ro
    environment:
      LAM_BASE_URL: http://lam:8080
      LAM_API_URL: http://lam:8080/v1
      LAM_ADMIN_TOKEN: ${LAM_ADMIN_TOKEN:-"demo-admin"}
      LAM_DEMO_TENANT_ID: "1"
      LAM_DEMO_NAMESPACE: "default"
      LAM_DEMO_SCOPE_USER: "auto"

volumes:
  lam_hello_pg:
